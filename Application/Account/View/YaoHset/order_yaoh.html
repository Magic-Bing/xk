<!DOCTYPE html>
<html>
    <head>
        <title><{$seo_title}></title>
        <meta name="keywords" content="云销控-选房摇号">
        <meta name="description" content="云销控-选房摇号">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link href="/Public/account/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/Public/common/css/base.css" type="text/css" rel="stylesheet">

        <script src="/Public/common/js/jquery/jquery-1.11.3.min.js"></script>
        <script src="/Public/common/js/jquery/jquery-ui-1.12.0.custom/jquery-ui.js"></script>
        <script src="/Public/account/assets/js/bootstrap.min.js"></script>
        <script src="/Public/common/js/jquery/jquery.mousewheel.js"></script>
        <link href="/Public/common/js/jquery/perfect-scrollbar/perfect-scrollbar.css" type="text/css" rel="stylesheet">
        <script src="/Public/common/js/jquery/perfect-scrollbar/perfect-scrollbar.js"></script>
        <script src="/Public/common/js/layer/layer.js"></script>
        <script src="/Public/common/js/pc/functions.js"></script>
        <script src="/Public/common/js/functions.js"></script>

        <style>
            body{
                /*background:url(/Public/account/img/yaohbk.jpg);
                background-repeat: no-repeat;  
                background-size: cover;
                background-attachment:fixed;*/
            }
            .yaohbackground{
                position: absolute;width:90%;height:90%;left:5%;top:5%; 
                Color:#000;
            }
            .content{
                float:left;width:calc(83% - 1px);height:100%;margin-left: 2%;
                background: rgba(255, 254, 254, 0.62);
               
            }
            .thumbnail{
                background-color:rgba(255, 255, 255, 0.6);
            }
            .start, .stop, .end  {
                padding: 5px 25px;
                text-align: center;
                font-size: 25px;
                border-radius: 10px;
                margin: auto;
                color: #ffffff;
                cursor: pointer;
            }
            .start {
                background: #fb3b3b;
            }
            .stop {
                background: #610907b3;
            }
            .end {
                background: #ccc;
            }
            .nextgroup  {
                padding: 3px 10px;
                text-align: center;
                font-size: 25px;
                border-radius: 0px;
                margin: auto;
                color: #fb3b3b;
                cursor: pointer;
            }
            #morezc li{
                margin-left: 5%;
                width:90%;
                border-bottom:1px solid #dff0d8;
                cursor: pointer;
            }
            .rcno{
                padding: 5px;
                background: #791311;
                color: #FFF;
            }
            .spanshow{
                line-height: 30px;
                width: 80%;
                margin-left: 10%;
                background: #FFF;
                margin-top: 7.5px;
            }
            .cstli div{
                overflow:hidden;
                white-space:nowrap;
                text-overflow:ellipsis;
            }
            marquee{
                height: calc(100% - 59px);
            }
            #user-div{
                height: calc(100% - 59px);
                overflow: hidden;
            }
            .col-sm-20{
                 width: 20%;
                 height: 100%;
                min-width: 200px;
                float: left;
             }
            .col-sm-20>div{
                height: 100%;
            }
            .xh{
                width: 20px;
                height: 20px;
                text-align: center;
                line-height: 20px;
                background:#fb7617;
                color: #fff;
                font-size:11px;
                float: left;
            }
            .group-user{
                width: 100%;
                height: calc(100% - 20px );
                float: left;
            }
            .group-table{
                width: 100%;
                color: #791311;
                line-height: 22px;
            }
            #close-group{
               width: 20px;
                height: 20px;
                float: right;
                border-radius: 10px;
                border: 1px solid #009688;
                line-height: 17px;
                text-align: center;
                color: #009688;
                cursor: pointer;
            }
            .group-title{
                width: 100%;
                margin-top: 10px;
                color: #fff;
                background: rgba(143, 19, 17, 0.45);
                font-size: 15px;
            }
            .group-title th{
                width: 33%!important;
                text-align: center;
            }
            .group-table tr>td:first-child{
                width: 33%!important;
               text-align: center;
            }
            .group-table tr>td:nth-child(2){
                width: 33%!important;
                max-width: 60px;
                text-align: center!important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .group-table tr>td:nth-child(3){
                width: 33%!important;
                text-align: center!important;
            }
            .close-add{
                display: none;
            }
            #cz-div{
                display: none;
            }
        </style>
    </head>
    <body style="width:100%;height:100%">
        <img id="bjimg" src="/Public/account/img/yaohbk.jpg" original="/Public/account/img/yaohbk.jpg" style="width:100%;height:100%;" >
        <div  class="yaohbackground">
            <div style="float:left;width:15%;height:100%;background: rgba(255, 254, 254, 0.62);">
                <div style="position: relative;top: 0;height: 59px;line-height: 59px;font-size: 20px;border-bottom: 1px solid red;text-align: center">待摇号</div>
                <if condition="$isend eq 0">
                    <!--<marquee direction="up" scrollamount="10"  width="100%"   >-->
                    <div style="position: relative;text-align: center;color: #770a07;" id="user-div">
                        <table style="width: 90%;margin-left: 5%" id="user_list">
                        <foreach name="cstlist" item="vo" key="k">
                          <tr>
                              <td style="width: 70%;text-align: left;max-width: 90px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis" data-id="<{$vo.id}>"><{$vo.customer_name}></td>
                              <td style="width: 30%;text-align: right"><{$vo.cyjno}></td>
                          </tr>
                        </foreach>
                        </table>
                    </div>

                  <!--</marquee>-->
                </if>
            </div>
            <div class="content">
                <div id="grouptitle" data_id="<{$yaohset['id']}>" style="width:100%;height:59px;line-height:59px;border-bottom:1px solid #fb3b3b;">
                    <div style="position: absolute;float:left;width:120px;text-align: center;font-size: 20px;">开盘摇号
                    </div>
                    <div  id="groupno" class="" style="float:left;width: calc(100%);text-align: center;font-size: 25px;">
                        <if condition="$isend eq 0">第 <php>$dqgroup=$yaohset['dqmaxgroup'];$dqgroup++;</php> <{$dqgroup}> 组</if>   
                    </div>
                    <if condition="$yaohset['dqmaxgroup'] gt 0">
                    <div style="position: absolute;right: 20px;width:120px;text-align: center;font-size: 15px;">
                        <php>$i=0;</php>
                        <select id="morezc"  name="showcontent" style="background: rgba(0, 0, 0, 0);color: rgba(0, 0, 0, .3);width: 100%">
                        <option value="0" >查看历史组次</option>
                            <for start="$i" end="$yaohset['dqmaxgroup']">
                                <php>$zch = $i + 1;</php>
                                <option value="<{$zch}>" >第 <{$zch}> 组</option>          
                            </for>
                        </select>
                    </div>
                    </if>  
                </div>
                <div  style="width:100%;height:calc(100% - 120px)">
                    <div style="width:90%;height:2%;"></div>
                    <div style="min-width:1000px;width:90%;height:96%;margin-left: 5%;white-space: nowrap;overflow: hidden" id="div-group">
                        <if condition="$isend eq 0">
                                <div class="col-sm-20" data-group="1" id="cz-div">
                                    <div class="thumbnail">
                                        <div class="xh">1</div>
                                        <div class="close-add">×</div>
                                        <div class="group-user">
                                            <table class="group-title">
                                                 <tr>
                                                     <th>入场序号</th>
                                                     <th>姓名</th>
                                                     <th>诚意单号</th>
                                                 </tr>
                                            </table>
                                               <table class="group-table">

                                               </table>
                                        </div>
                                    </div>
                                </div>
                        <else />
                        <div style="position: absolute;top: 50%;left: 50%;font-size: 25px;">
                            摇号已结束
                        </div>
                        
                        </if>
                    </div>
                </div>
              
                <div style="width:100%;height:59px;border-top:1px solid #fb3b3b;">
                    <if condition="$isend eq 0">
                    <div style="width:100%;margin-top: 5px;">
                        <div style="position:absolute;left: 45%;">
                            <div class="start"  id="add-group" onclick="start()">增加</div>
                        </div>
                        <div style="position:absolute;right: 5%;">
                            <div class="nextgroup" id="nextgroup" style="display: none" onclick="window.location.reload()">下一组 ></div>
                        </div>
                        <div style="position:absolute;left:65%;">
                            <div class="start" id="submit-yh">确定 </div>
                        </div>
                    </div>
                    </if>
                </div>
                
            </div>
            
        </div>
        <script  type="text/javascript">
            var num='<{$yaohset["mzgs"]}>';
            var qsz='<{$yaohset["dqmaxno"]}>';
            var ysz=qsz;
            var yid='<{$yaohset["id"]}>';
            function compare(property){
                return function(a,b){
                    var value1 = a[property];
                    var value2 = b[property];
                    return value1 - value2;
                }
            };
             $(document).ready(function() {
                $("#bjimg").css("height",$(window).height());
             });
             $(window).resize(function () {         
               $("#bjimg").css("height",$(document).height());
            });
             $("#add-group").trigger("click");
             //摇号
            function start() {
                var tb=$("#user_list");
                var len=tb.find('tr').length;
                if(len===0){
                    layer_alert("已经没有客户了,请点击确定！");
                }
                var cz=$("#cz-div");
                var g_num=cz.attr("data-group");
                var g_tab=cz.find(".group-user").find(".group-table");
                if(g_num !== '1'){
                    var t=$("#close-group").next(".group-user").find('.group-table').find("tr:last").find("td:first").text();//获取当前摇到好多位
                    qsz=t.replace(/[^0-9]/ig,"");//取出字符串中的数字
                }
                var n=Number(qsz);
                var num1=0;
                for(var i=(num-1);i>=0;i--){
                    num1=n+i+1;
                    tb.find("tr").eq(i).prepend("<td>第"+num1+"位</td>").prependTo(g_tab);
                }
                var len2=tb.find('tr').length;
                $(".close-add").css("display","none").attr("id",'');
                cz.find(".close-add").attr("id","close-group").css("display","block");
                cz.attr("id",'');
                if(len2===0){
                    $(".col-sm-20:first").find(".close-add").attr("id","close-group").css("display","block");
                    return false;
                }
                var str='<div class="col-sm-20" id="cz-div" data-group="'+(Number(g_num)+1)+'">' +
                             '<div class="thumbnail">' +
                                '<div class="xh">'+(Number(g_num)+1)+'</div>' +
                                '<div class="close-add">×</div>' +
                                '<div class="group-user">' +
                                    '<table class="group-title">' +
                                        '<tr>' +
                                            '<th>入场序号</th>' +
                                            '<th>姓名</th>' +
                                            '<th>诚意单号</th>' +
                                        ' </tr>' +
                                    '</table>' +
                                    '<table class="group-table">' +
                                    '</table>' +
                                 '</div>' +
                            '</div>' +
                        '</div>';
                $(str).prependTo("#div-group");
            }
            //删除摇号
            $(document).on("click","#close-group",function () {
                var tb=$("#user_list");
                var g_tab=$(this).nextAll(".group-user").find(".group-table");
                for(var i=(num-1);i>=0;i--){
                    g_tab.find("tr").eq(i).find('td').eq(0).remove();
                    g_tab.find("tr").eq(i).prependTo(tb);
                }
                var d=$(this).parent("div").parent("div");
                var v=d.attr("data-group");
                d.remove();
                var cz=$("#cz-div");
                var vo=cz.attr("data-group");
                var  str='';
                if(vo === undefined){
                     str='<div class="col-sm-20" id="cz-div" data-group="'+v+'">' +
                        '<div class="thumbnail">' +
                        '<div class="xh">'+v+'</div>' +
                        '<div class="close-add">×</div>' +
                        '<div class="group-user">' +
                        '<table class="group-title">' +
                        '<tr>' +
                        '<th>入场序号</th>' +
                        '<th>姓名</th>' +
                        '<th>诚意单号</th>' +
                        ' </tr>' +
                        '</table>' +
                        '<table class="group-table">' +
                        '</table>' +
                        '</div>' +
                        '</div>' +
                        '</div>';
                    $(str).prependTo("#div-group");
                    $(".col-sm-20").eq(1).find(".close-add").attr("id","close-group").css("display","block");
                }else{
                        cz.attr("data-group",(Number(vo)-1));
                        var vo1= $.trim(cz.find(".xh").html());
                        cz.find(".xh").html((Number(vo1)-1));
                        if(Number(v) !== 1){//判断是否是第一小组，是第一小组就不需要新增div
                            if(cz.length===0){//判断操作的div是否存在
                                str='<div class="col-sm-20" id="cz-div" data-group="'+v+'">' +
                                    '<div class="thumbnail">' +
                                    '<div class="xh">'+v+'</div>' +
                                    '<div class="close-add">×</div>' +
                                    '<div class="group-user">' +
                                    '<table class="group-title">' +
                                    '<tr>' +
                                    '<th>入场序号</th>' +
                                    '<th>姓名</th>' +
                                    '<th>诚意单号</th>' +
                                    ' </tr>' +
                                    '</table>' +
                                    '<table class="group-table">' +
                                    '</table>' +
                                    '</div>' +
                                    '</div>' +
                                    '</div>';
                                $(str).prependTo("#div-group");
                            }
                            $(".col-sm-20").eq(1).find(".close-add").attr("id","close-group").css("display","block");
                        }else{
                            qsz=ysz;
                        }
                }


            });
            //提交摇号
            $(document).on("click","#submit-yh",function () {
                var tr=$(".group-table").find("tr");
                var len=tr.length;
                var data=[];
                for(var i=0;i<len;i++){
                    var arr=[];
                    var n=tr.eq(i).find("td").eq(0).text();
                    n=Number(n.replace(/[^0-9]/ig,""));//取出字符串中的数字
                    arr[0]=n;
                    arr[1]=tr.eq(i).find("td").eq(1).attr("data-id");
                    data[i]=arr;
                }
                data.sort(compare(0));//数组排序，按照字段px排序
                $.ajax({
                    type:"post",
                    url:"<{:U('add_yh')}>",
                    data:{id:yid,data:data},
                    dataType:'JSON',
                    success:function (data) {
                        console.log(data);
                       if(data.status===1){
                           $("#nextgroup").show();
                           $("#add-group").remove();
                           $("#submit-yh").css("background-color","#e7e7e7").off("click");
                           $("#close-group").remove();
                           layer.msg(data.info[0]);
                       }else{
                           layer_alert(data.info);
                       }
                    }
                });
            });
            $(document).on("change","#morezc",function () {
                var zcid=$("#morezc").val();
                if(zcid>0)
                {
                    window.location.href="http://"+window.location.host+"/Account/YaoHset/history_order/id/" + $("#grouptitle").attr("data_id") + "/zcid/"+ zcid
                }
            });
        </script>
    </body>
</html>