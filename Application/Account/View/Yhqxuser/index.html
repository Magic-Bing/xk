<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>用户管理</title>
</head>
<body>
<extend name="Common/base" />
<block name="breadcrumb_active">
	<li><{$classify_name|default=''}></li>
	<li class="active"><{$seo_title|default=''}></li>
</block>
<block name="page_content">
<style type="text/css">
#tagscontent {
    border-top: none;
    height: auto;
    /* font-size: 12px; */
    color: #1B4670;
    text-align: left;
}

#tagscontent tr {
    line-height: 20px;
    height: auto;
    clear: both;
}

#tagscontent .table_td th, #tagscontent #table th {
    background: #f2f2f2;
    text-align: center;
    font-size: 13px;
    border: 1px solid #DDD;
}
#tagscontent th {
    color: #707070;
}

#tagscontent td {
    font-size: 13px;
    color: #1B4670;
    border: 1px solid #e8eef6;
}
.search {
    text-align: left;
    background: #fcf9f4;
    /*height: 38px;*/
    line-height: 38px;
    float:right;
    margin-right: 10px
}

.search_content {
    margin-top: 0px;
    color: #393939;
    padding-left: 20px;
    font-size:12px;
    background: #eff3f8;
}
.search_content label{
    margin-left: 5px;
}
.search_content input{
    width:100px;
    padding: 3px 4px;
}
.page_newc
{
    height: 34px;
    background: #F5F5F5;
    
}

/* 通用分页 */
.page-container {
	text-align: right;
	/*padding: 10px 0; */
	margin-top: 5px;
	background: #F5F5F5;
}
.page-container .num,
.page-container .prev,
.page-container .next,
.page-container .first,
.page-container .end,
.page-container .rows,
.page-container .current
{
	padding: 5px;
	display: inline-block;
	padding: 5px 9px;
    background: #d1cfd6;
	color: #0076cf;
	font-size: 16px;
}
.page-container .current
{
    background: #ff6600;
    color: #fff;
	font-weight: bold;
	cursor: pointer;
}
.page-container .num:hover,
.page-container .prev:hover,
.page-container .next:hover,
.page-container .first:hover,
.page-container .end:hover,
.page-container .rows:hover,
.page-container .current:hover
{
    background: #d08553;
	color: #FFF;
}

.button {
    /* background: url('__IMG__/buttom_bg.gif') right bottom no-repeat; */
    height: 24px;
    line-height: 18px;
    cursor: pointer;
    text-align: center;
    padding: 2px 10px;
    border: 1px solid #c4d9e9;
    background: #ffffff;
    color: #1f74bd;
    overflow: hidden;
    margin-left: 20px;
	font-size:12px;
}
.showtop_t {
    font-weight: bold;
    text-align: left;
    color: #0086ae;
    padding-left: 20px;
    padding-top: 5px;
}
.show_content_m_t2 {
    width: 100%;
    border-left: 1px solid #fff;
    border-right: 1px solid #fff;
    background-color: #fff;
}

.select_page {
    width: 400px;
    margin-left: 20px;
    float: left;
}
a:link {
    color: #0076cf;
    text-decoration: none;
    /*font-weight:bold;*/
}


.delurl {
    background: url('__IMG__/buttom_bg.gif') right bottom no-repeat;
    line-height: 22px;
    cursor: pointer;
    text-align: center;
    padding: 5px 10px;
    border: 1px solid #c4d9e9;
    color: #395366;
    overflow: hidden;
    margin-left: 20px;
    font-size: 14px;
}

.xzblddiv{
    color: #dc2d0e;
    cursor: pointer;
    margin: auto;
    text-align: center;
}
a{
cursor:pointer;
}

.row-fluid
{
position:absolute;
width:260px;
height:300px;
background:blue;
margin-left:400px;
margin-top:100px;
}

/* 房间列表 */
.room-title-project {
	font-size: 13px;
	font-weight: bold;
}

.room-nav-edit {
	clear: both;
	margin: 0;
	padding: 0;
}
.room-nav-edit .room-nav-edit-btn {
	list-style: none;
	display: inline-block;
	padding: 0 7px;
}
.room-export-btn {
	width:66px;
	color:#FFF;
	font-size: 13px;
}
.room-export-btn:link {
	color:#FFF;
}
.room-export-icon-in {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
	display: inline-block;
	background: url(__IMG__/dr01.png) no-repeat scroll 0 2px/14px 14px;
	width: 15px;
	height: 15px;
}
.room-export-icon-out {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
	display: inline-block;
	background: url(__IMG__/dr01.png) no-repeat scroll 0 2px/14px 14px;
	width: 15px;
	height: 15px;
}
.room-export-icon-refresh {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
	display: inline-block;
	background: url(__IMG__/sx01.png) no-repeat scroll 0 2px/18px 15px;
	width: 20px;
	height: 17px;
}
.room-project {
	/*padding-top: 10px;
	margin: 5px 0;*/
	background: #f5f5f5;
	border-left: 2px solid #e4d7c1;
}
.a_tb_bg{
    width: 20px;
    background: #D45C36;
    padding: 3px 5px;
    margin-left: 5px;
}
.adduser_btn{
    line-height: 20px;
    float: left;
    margin-right: 20px;
    background: #d6487e;
    padding: 1px 5px;
}

#table>tbody>tr:nth-child(odd)>td{
    background-color: #f9f9f9;
}
.pagerow{
    padding-top: 12px;
    padding-bottom: 12px;
    background-color: #eff3f8;
    border-bottom: 1px solid #DDD;
}
    form{
        display: inline;
    }
</style>
<div class="row">
    <div class="col-xs-12">
    <div class="table-header">
	<span style="">用户列表</span>
    </div>
    <div class="show_content_m_t2">
        <div style="width:100%;overflow-x:hidden;overflow-y:hidden"> 
            <div style="background: #eff3f8;height: 43px;">   
                <div style="display:block;float:left;line-height: 38px;">
                    <font style="margin-left:10px;">公司</font>
                    <select id= "companys" name="companys" style="padding: 1px 10px;height:25px;" >
                    <if condition="$cp_id gt 0">
                            <foreach name="companys" item="companys_vo">
                            <if condition="$cp_id eq $companys_vo['id']">
                              <option value="<{$companys_vo['id']}>" selected>
                                    <{$companys_vo['compname']}>
                              </option>
                            <else />		 
                              <option value="<{$companys_vo['id']}>">
                                    <{$companys_vo['compname']}> 
                              </option>
                            </if>
                            </foreach> 
                    <else />
                            <option value="0" selected></option>
                             <foreach name="companys" item="companys_vo">
                               <option value="<{$companys_vo['id']}>">
                                    <{$companys_vo['compname']}>
                               </option>
                            </foreach> 
                    </if>
                    </select>

                     <form method="post" id="selectcomp" name="selectcomp" action="index" style="display:none">
                            <input type="text" id="cp_id" name="cp_id" value="">
                            <input type="submit" value="提交查询" class="button">  
                    </form>
                </div>
                <div class="search">
                    <div class="search_content">	 
                        <form method="post"  action="index" id="form-b">
                            <input type="hidden" name="cp_id" value="<{$cp_id}>">
                            <input type="hidden" name="p" value="<{$p|default=1}>">
                            <label>用户名称</label>
                            <input type="text" name="name" value="<{$name}>">
                            <label>用户代码</label>
                            <input type="text" name="code" value="<{$code}>">
                            <label>电话号码</label>
                            <input type="text" name="mobile" value="<{$mobile}>">
                            <input type="submit" value="提交查询" class="button room-search-button">
                        </form>
                    </div>

                </div>
            </div>

            <div class="tags" style="width: 100%;padding: 0;border: 0;">
                <div id="tagstitle"></div>
                <div id="tagscontent">
                    <div id="con_one_1">
                        <div class="table_td">
                            <table border="0" cellspacing="2" cellpadding="4" class="list" name="table" id="table" width="100%">
                                <thead>
                                    <tr>
                                        <th width="80px"><input type="checkbox" id="chkall" name="chkall" onclick="checkall()"></th> 
                                        <th align="center">所属公司</th>
                                        <th align="center">用户名称</th>
                                        <th align="center">用户代码</th> 
                                        <th align="center">用户手机</th>
                                        <th align="center">状态</th>
                                        <th align="center" style="width:100px">操作</th>
                                    </tr>
                                </thead> 
                                <tbody id="userlisttb">
                                <foreach name="userlist" item="userlist_vo">
                                    <tr class="s_out user-item-<{$userlist_vo['id']}>" onmouseover="this.bgColor='#F5F5F5';" onmouseout="this.bgColor='ffffff';" bgcolor="#ffffff"> 
                                        <td align="center" ><input type="checkbox" class="selectuser" name="id[]" value="<{$userlist_vo['id']}>"></td> 
                                        <td align="left"> <{$userlist_vo['compname']}> </td> 
                                        <td align="left"><a href="edit.html?id=<{$userlist_vo['id']}>" style="text-decoration: underline;"><{$userlist_vo['name']}><a></td> 
                                                    <td align="left"> <{$userlist_vo['code']}> </td> 
                                                    <td align="left"><{$userlist_vo['mobile']}></td>
                                                    <td class="center">
                                                        <if condition="$userlist_vo['status'] eq 0">
                                                            <span style="cursor: pointer" class="label label-sm label-success click-status" data-id="<{$userlist_vo['id']}>" data-s="0">启用</span>
                                                            <else/>
                                                            <span style="cursor: pointer" class="label label-sm label-warning click-status" data-id="<{$userlist_vo['id']}>" data-s="1">关闭</span>
                                                        </if>
                                                    </td>
                                                    <td align="center">
                                                        <a href="edit.html?id=<{$userlist_vo['id']}>" >
                                                            <span style="padding: 3px 3px;background-color: #6fb3e0;color: #FFF;" title="修改">
								<i class="icon-edit bigger-120"></i>
                                                            </span>
                                                        </a> 
                                                        <a class="a_tb_bg" onclick="deluser(<{$userlist_vo['id']}>,0)"> 
                                                            <span class="white" title="删除">
								<i class="icon-trash bigger-120"></i> 
                                                            </span>
                                                        </a>
                                                    </td> 
                                                    </tr> 
                                                    </foreach> 
                                                    <tr>
                                                        <td>
                                                            <div class="xzblddiv action-buttons"  >
                                                                <a title="批量删除" onclick="pldeluser()">
                                                                    <i class="icon-trash bigger-130" style="color:#dd5a43;"></i>
                                                                </a>
                                                                <a title="批量关闭" onclick="plcloseuser()">
                                                                    <i class="icon-eye-close bigger-130" style="color:#dd5a43;"></i>
                                                                </a>
                                                            </div>
                                                        </td>
                                                        <td colspan="10">
                                                            <a href="add.html" class="btn btn-xs btn-pink" style="color:#FFF"><i class="icon-file bigger-110"></i> 新增用户</a>
                                                            <button class="btn btn-xs btn-primary" id="moban-out">
                                                                <i class="icon-cloud-download bigger-110" ></i>
                                                                <span class="bigger-110 no-text-shadow">导出模板</span>
                                                            </button>
                                                            <form action="" enctype="multipart/form-data" id="upload-user" style="display: inline">
                                                                <input type="file" name="excel" style="display: none" accept="application/vnd.ms-excel" id="file">
                                                                <button type="button" class="btn btn-xs btn-primary " onclick="$('input[type=file]').click();" id="moban-in">
                                                                    <i class="icon-cloud-upload bigger-110"></i>
                                                                    <span class="bigger-110 no-text-shadow" >导入数据</span>
                                                                </button>
                                                            </form>
                                                            <button class="btn btn-xs btn-primary"  style="float: right" id="user-out">
                                                                <i class="icon-cloud-download bigger-110"></i>
                                                                <span class="bigger-110 no-text-shadow">导出用户数据</span>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    </tbody> 

                                                    </table>

                                                    <div class="row pagerow">
                                                        <div class="col-sm-6">
                                                                <div class="dataTables_info" id="sample-table-2_info">
                                                                &nbsp;&nbsp;第 <{$p|default=1}> / <{$total_pages|default=1}> 页，共 <{$count|default=1}> 条
                                                                </div>
                                                        </div> 
                                                        <div class="col-sm-6">
                                                                <div class="dataTables_paginate paging_bootstrap"> 
                                                                        <{$page_show|default=''}>
                                                                </div>
                                                        </div>
                                                    </div>
                            </div>
                        </div>
                    </div>
                </div>    
            </div> 
    </div>

 
    </div>
</div>

</block>
<block name="page_js">
<script type="text/javascript">
    var c_num="<{$p}>";
$(function() {
    //分页跳转
    $(".pagination li").on("click",function () {
        var tx=$(this).attr("data-tx");
        var ip= $("#form-b input[name='p']");
        if(tx !==undefined){
            if(tx ==="上一页"){
                ip.val(Number(c_num)-1);
            }else if(tx ==="下一页"){
                ip.val(Number(c_num)+1);
            }else if(tx ==="首页"){
                ip.val(1);
            } else if(tx ==="尾页"){
                ip.val("<{$total_pages|default=1}>");
            }else{
                ip.val(tx);
            }
            $(this).find("a").removeAttr("href");
            $("#form-b").submit();
        }
    });
    $("#form-b input").on("keyup",function () {
        if(event.keyCode ===13){
            $("#form-b input[name='p']").val("1");
            $("#form-b").submit();
        }
    });
    //单个点击启用，或者禁用用户
    $(".click-status").on("click",function () {
        var pd=$(this).attr("data-s");
        var id=$(this).attr("data-id");
        var t=$(this);
        var vo=0;
        if(Number(pd)===1){
            vo=0;
        }else{
            vo=1;
        }
        $.post("<{:U('/Account/Yhqxuser/updateStatus')}>",{status:vo,id:id},function (data) {
//                layer_confirm('确认删除吗，删除后将不能恢复？', callback);
            if(data==='false'){
                layer.alert('操作失败，请刷新重试！');
            }else{
                    if(vo===0){
                        t.removeClass("label-warning").addClass("label-success").attr("data-s",vo).text('启用');
                        layer.msg('启用成功！');
                    }else{
                        t.removeClass("label-success").addClass("label-warning").attr("data-s",vo).text('关闭');
                        layer.msg('关闭成功！');
                    }

            }
        });
    });

    //导入数据
    $(document).on("change","#file",function(){
        var f=$(this);
        var formdata = new FormData($('#upload-user')[0]);
        $.ajax({
            url:"<{:U('/Account/Yhqxuser/check_in_user')}>",
            type:"post",
            processData:false,
            contentType:false,
            dataType:"json",
            data:formdata,
            success:function(data){
                console.log(data);
                f.val("");
                if(data.hasOwnProperty("in_error")){
                    layer.closeAll();
                    layer_alert('存在异常数据！，一共'+data['in_all']+'条，导入成功'+(data['in_all']-data['in_error'])+"条，点击确认后下载异常数据.",function () {
                        layer.closeAll();
                        window.open("http://"+window.location.host+data['error_path']);
                        window.location.reload();
                    });
                }else if(data.hasOwnProperty("in_all")){
                    layer.closeAll();
                    layer_msg('全部导入成功');
                    window.location.reload();
                }else{
                    layer_alert(data.info);
                }
            }
        });
    });

    //导出用户数据
    $("#user-out").on("click",function () {
        var code=$("input[name='code']").val();
        var name=$("input[name='name']").val();
        var mobile=$("input[name='mobile']").val();
        var cp_id=$("#companys").val();
//        console.log(code);
//        console.log(name);
//        console.log(mobile);
//        console.log(cp_id);
//        return false;
        window.location.href="<{:U('/Account/Yhqxuser/check_out_user_data')}>"+"?code="+code+"&name="+name+"&mobile="+mobile+"&cp_id="+cp_id;
    });
    $("#moban-out").on("click",function () {
        var cid=$("#companys").val();
       window.location.href="<{:U('/Account/Yhqxuser/check_out_user')}>?cid="+cid;
    });

    $("#companys").change(function(){
            $("#cp_id").val($("#companys option:selected").val());
            $("#selectcomp").submit();
      });  
});

function deluser($id,$type)
    {
            if ($id==0)
            {
                    layer_alert("数据异常，请稍后重试");
                    return false;
            }
            var callback = function() {
			 var $user_url = {deluser: '<{:U("deluser")}>',}
			
			var $data = {
				id: $id,
			}
			
			ajax_post_callback($user_url.deluser, $data, function(data, status) {
				if (data['status'] != 1) {
					gritter_alert(data['info']);
					return false;
				} else {
					gritter_alert_success('删除成功！');
					
					setTimeout(function() {
						$(".user-item-" + $id).remove();
					}, 200);
				}			
			});
		}
                layer_confirm('确认删除此用户吗？', callback);
    }

    function pldeluser()
    {
            var $userlist="";
            var $alluser=$("#userlisttb").find(".selectuser")

            for(var i=0;i<$alluser.length;i++)
            {
                    if ($alluser.eq(i).is(':checked'))
                            $userlist+=$alluser.eq(i).val()+"|";
            }

            if ($userlist=="")
            {
                    layer_alert('请选择用户！');
                    return false;
            }
            else{
                    $userlist=$userlist.substring(0,$userlist.length-1);
            }
            
            var callback = function() {
			 var $user_url = {pldeluser: '<{:U("pldeluser")}>',}
			
			var $data = {
				userlist: $userlist ,
			}
			
			ajax_post_callback($user_url.pldeluser, $data, function(data, status) {
				if (data['status'] != 1) {
					gritter_alert(data['info']);
					return false;
				} else {
					gritter_alert_success('删除成功！');
					
					setTimeout(function() {
						window.location.reload();
					}, 200);
				}			
			});
		}
                layer_confirm('确认批量删除？', callback);
    }
    
    function plcloseuser()
    {
            var $userlist="";
            var $alluser=$("#userlisttb").find(".selectuser")

            for(var i=0;i<$alluser.length;i++)
            {
                    if ($alluser.eq(i).is(':checked'))
                            $userlist+=$alluser.eq(i).val()+"|";
            }

            if ($userlist=="")
            {
                    layer_alert('请选择用户！');
                    return false;
            }
            else{
                    $userlist=$userlist.substring(0,$userlist.length-1);
            }
            
            var callback = function() {
			 var $user_url = {plcloseuser: '<{:U("plcloseuser")}>',}
			
			var $data = {
				userlist: $userlist ,
			}
			
			ajax_post_callback($user_url.plcloseuser, $data, function(data, status) {
				if (data['status'] != 1) {
					gritter_alert(data['info']);
					return false;
				} else {
					gritter_alert_success('关闭用户成功！');
					
					setTimeout(function() {
						window.location.reload();
					}, 200);
				}			
			});
		}
                layer_confirm('确认批量关闭？', callback);
    }

    function checkall()
    { 
            var $checkinfo = $('#chkall').is(':checked');
            if($checkinfo ==  true){
                    $("input[name='id[]']").prop("checked",true); 
            }else{
                    $("input[name='id[]']").prop("checked",false); 
            } 
    }
</script>
</block>
</body>
</html>